---
import '../styles/global.css';
import LineChart from '../components/charts/LineChart.astro';
import BarChart from '../components/charts/BarChart.astro';
import ProgressRing from '../components/charts/ProgressRing.astro';
import StatCard from '../components/charts/StatCard.astro';
import { supabase } from '../lib/supabase';
import { parseLocalDate, formatShortDate, getMonday } from '../lib/dates';

const user = Astro.locals.user;

// Obtener workouts del usuario
const { data: workoutsData } = await supabase
  .from('workouts')
  .select(`
    id,
    workout_date,
    exercise_history (
      id,
      weight,
      reps,
      variant_equipment,
      variant_grip,
      variant_position,
      exercises (
        id,
        name,
        muscle_group
      )
    )
  `)
  .eq('user_id', user?.id)
  .order('workout_date', { ascending: false });

// Obtener favoritos del usuario
const { data: favoritesData } = await supabase
  .from('user_favorite_exercises')
  .select(`
    id,
    exercise_id,
    variant_equipment,
    variant_grip,
    variant_position,
    exercises (
      id,
      name,
      muscle_group
    )
  `)
  .eq('user_id', user?.id);

const hasData = workoutsData && workoutsData.length > 0;

// Flatten all exercise history for calculations
const historyData = workoutsData?.flatMap(w => w.exercise_history || []) || [];

// Calcular estadisticas
const now = new Date();
const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

const totalWorkouts = workoutsData?.length || 0;
const totalVolume = historyData.reduce((acc, h) => acc + (h.weight * h.reps), 0);

// Entrenamientos esta semana
const thisWeek = workoutsData?.filter(w => {
  const date = parseLocalDate(w.workout_date);
  return date >= oneWeekAgo;
}).length || 0;

// Calcular racha actual
let currentStreak = 0;
const sortedWorkouts = workoutsData
  ?.map(w => parseLocalDate(w.workout_date))
  .sort((a, b) => b.getTime() - a.getTime()) || [];

if (sortedWorkouts.length > 0) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  let checkDate = new Date(today);

  for (const workoutDate of sortedWorkouts) {
    const wd = new Date(workoutDate);
    wd.setHours(0, 0, 0, 0);

    const diff = Math.floor((checkDate.getTime() - wd.getTime()) / (24 * 60 * 60 * 1000));

    if (diff <= 1) {
      currentStreak++;
      checkDate = wd;
    } else {
      break;
    }
  }
}

const stats = {
  totalWorkouts,
  totalVolume,
  currentStreak,
  thisWeek,
};

// Mapeo de músculos granulares a grupos grandes
const muscleToGroup: Record<string, string> = {
  // Brazos
  'Bíceps': 'Brazos',
  'Tríceps': 'Brazos',
  'Antebrazos': 'Brazos',
  // Piernas
  'Cuádriceps': 'Piernas',
  'Isquiotibiales': 'Piernas',
  'Glúteos': 'Piernas',
  'Pantorrillas': 'Piernas',
  // Espalda
  'Dorsales': 'Espalda',
  'Espalda Baja': 'Espalda',
  'Trapecios': 'Espalda',
  // Hombros
  'Deltoides': 'Hombros',
  // Core
  'Abdominales': 'Core',
  // Se mantienen igual
  'Pecho': 'Pecho',
  'Hombros': 'Hombros',
  'Core': 'Core',
  'Brazos': 'Brazos',
  'Piernas': 'Piernas',
  'Espalda': 'Espalda',
};

// Volumen por grupo muscular GRANDE (ultimo mes) - para el primer gráfico
const volumeByGroupMap = new Map<string, number>();
// Volumen por músculo GRANULAR (ultimo mes) - para el segundo gráfico
const volumeByMuscleMap = new Map<string, number>();

workoutsData?.forEach(workout => {
  const workoutDate = parseLocalDate(workout.workout_date);
  if (workoutDate >= oneMonthAgo) {
    workout.exercise_history?.forEach(h => {
      if (h.exercises) {
        const muscle = h.exercises.muscle_group;
        const volume = h.weight * h.reps;

        // Agregar al mapa granular
        volumeByMuscleMap.set(muscle, (volumeByMuscleMap.get(muscle) || 0) + volume);

        // Agregar al mapa de grupos grandes
        const group = muscleToGroup[muscle] || muscle;
        volumeByGroupMap.set(group, (volumeByGroupMap.get(group) || 0) + volume);
      }
    });
  }
});

// Top 5 GRUPOS GRANDES para el gráfico principal
const volumeByMuscle = Array.from(volumeByGroupMap.entries())
  .map(([label, value]) => ({ label, value }))
  .sort((a, b) => b.value - a.value)
  .slice(0, 5);

// Todos los MÚSCULOS GRANULARES para el gráfico detallado (máximo 10)
const volumeByMuscleAll = Array.from(volumeByMuscleMap.entries())
  .map(([label, value]) => ({ label, value }))
  .sort((a, b) => b.value - a.value)
  .slice(0, 10);

// Ultimos entrenamientos
const recentWorkouts = workoutsData?.slice(0, 4).map(workout => {
  const dateStr = formatShortDate(workout.workout_date);
  const exercises = workout.exercise_history || [];
  const uniqueExercises = new Set(exercises.map(e => e.exercises?.id)).size;
  const volume = exercises.reduce((acc, e) => acc + (e.weight * e.reps), 0);
  return {
    date: dateStr,
    exercises: uniqueExercises,
    volume,
    duration: '-'
  };
}) || [];

// Helper para crear clave única de ejercicio + variantes
const getExerciseKey = (h: any) => {
  if (!h.exercises) return '';
  const variants = [];
  if (h.variant_equipment) variants.push(h.variant_equipment);
  if (h.variant_grip) variants.push(h.variant_grip);
  if (h.variant_position) variants.push(h.variant_position);
  return variants.length > 0
    ? `${h.exercises.name} (${variants.join(' · ')})`
    : h.exercises.name;
};

// Records personales (peso maximo por ejercicio+variante)
const prByExercise = new Map<string, { weight: number; dateStr: string; name: string }>();
workoutsData?.forEach(workout => {
  workout.exercise_history?.forEach(h => {
    if (h.exercises) {
      const key = getExerciseKey(h);
      const current = prByExercise.get(key);
      if (!current || h.weight > current.weight) {
        prByExercise.set(key, {
          weight: h.weight,
          dateStr: workout.workout_date,
          name: key
        });
      }
    }
  });
});

const personalRecords = Array.from(prByExercise.values())
  .sort((a, b) => b.weight - a.weight)
  .slice(0, 3)
  .map(pr => ({
    exercise: pr.name,
    weight: pr.weight,
    date: formatShortDate(pr.dateStr)
  }));

// Helper para crear clave de favorito
const getFavoriteKey = (fav: any) => {
  if (!fav.exercises) return '';
  const variants = [];
  if (fav.variant_equipment) variants.push(fav.variant_equipment);
  if (fav.variant_grip) variants.push(fav.variant_grip);
  if (fav.variant_position) variants.push(fav.variant_position);
  return variants.length > 0
    ? `${fav.exercises.name} (${variants.join(' · ')})`
    : fav.exercises.name;
};

// Comparar si un historial coincide con un favorito
const matchesFavorite = (h: any, fav: any) => {
  return h.exercises?.id === fav.exercise_id &&
    (h.variant_equipment || null) === (fav.variant_equipment || null) &&
    (h.variant_grip || null) === (fav.variant_grip || null) &&
    (h.variant_position || null) === (fav.variant_position || null);
};

// Obtener parámetros de filtro de URL
const url = new URL(Astro.request.url);
const periodType = url.searchParams.get('periodType') || 'last';
const periodValue = parseInt(url.searchParams.get('periodValue') || '4'); // 4 semanas por defecto
const dateFrom = url.searchParams.get('dateFrom');
const dateTo = url.searchParams.get('dateTo');

// Función para filtrar workouts según período (por semanas)
const filterWorkoutsByPeriod = (workouts: typeof workoutsData) => {
  if (!workouts) return [];

  if (periodType === 'last') {
    // Filtrar por últimas X semanas
    const weeksAgo = periodValue;
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - (weeksAgo * 7));
    cutoffDate.setHours(0, 0, 0, 0);

    return workouts.filter(w => {
      const workoutDate = parseLocalDate(w.workout_date);
      return workoutDate >= cutoffDate;
    });
  } else if (periodType === 'range' && dateFrom && dateTo) {
    const from = parseLocalDate(dateFrom);
    const to = parseLocalDate(dateTo);
    return workouts.filter(w => {
      const date = parseLocalDate(w.workout_date);
      return date >= from && date <= to;
    });
  }

  // Por defecto: últimas 4 semanas
  const defaultCutoff = new Date();
  defaultCutoff.setDate(defaultCutoff.getDate() - 28); // 4 semanas
  defaultCutoff.setHours(0, 0, 0, 0);
  return workouts.filter(w => {
    const workoutDate = parseLocalDate(w.workout_date);
    return workoutDate >= defaultCutoff;
  });
};

// Datos para grafico de progreso (ejercicios favoritos)
const colors = ['#30d158', '#ff9f0a', '#0a84ff', '#bf5af2', '#ff453a'];
const progressSeries: Array<{ name: string; data: { label: string; value: number }[]; color: string }> = [];

if (favoritesData && favoritesData.length > 0 && workoutsData && workoutsData.length > 0) {
  // Filtrar todos los workouts según el período seleccionado
  const allFilteredWorkouts = filterWorkoutsByPeriod(workoutsData);

  if (allFilteredWorkouts.length > 0) {
    // Crear un mapa de semanas únicas ordenadas cronológicamente
    const weeksMap = new Map<string, Date>();
    allFilteredWorkouts.forEach(w => {
      const monday = getMonday(w.workout_date);
      const key = monday.toISOString().split('T')[0];
      if (!weeksMap.has(key)) {
        weeksMap.set(key, monday);
      }
    });

    // Ordenar semanas cronológicamente y asignar índice (S1, S2, S3...)
    const sortedWeeks = Array.from(weeksMap.entries())
      .sort((a, b) => a[1].getTime() - b[1].getTime());

    // Crear mapa de weekKey -> índice de semana (S1, S2, etc.)
    const weekIndexMap = new Map<string, number>();
    sortedWeeks.forEach(([weekKey], index) => {
      weekIndexMap.set(weekKey, index + 1);
    });

    // Para cada favorito, construir datos por semana
    favoritesData.forEach((fav, index) => {
      const favKey = getFavoriteKey(fav);

      // Obtener el peso máximo por semana para este favorito
      const weightByWeek = new Map<string, number>();

      allFilteredWorkouts.forEach(w => {
        const exerciseSets = w.exercise_history?.filter(h => matchesFavorite(h, fav)) || [];
        if (exerciseSets.length > 0) {
          const maxWeight = Math.max(...exerciseSets.map(s => s.weight));
          const monday = getMonday(w.workout_date);
          const weekKey = monday.toISOString().split('T')[0];

          // Guardar el mayor peso de esa semana
          const existing = weightByWeek.get(weekKey) || 0;
          if (maxWeight > existing) {
            weightByWeek.set(weekKey, maxWeight);
          }
        }
      });

      // Solo agregar si tiene datos
      if (weightByWeek.size > 0) {
        // Construir datos para TODAS las semanas (con null donde no hay datos)
        const data = sortedWeeks.map(([weekKey]) => {
          const weekNum = weekIndexMap.get(weekKey)!;
          const weight = weightByWeek.get(weekKey);
          return {
            label: `S${weekNum}`,
            value: weight ?? null as any, // null si no hay datos esa semana
          };
        }).filter(d => d.value !== null); // Solo incluir semanas con datos

        if (data.length > 0) {
          progressSeries.push({
            name: favKey,
            data,
            color: colors[index % colors.length]
          });
        }
      }
    });
  }
}

// Preparar datos del último entrenamiento por ejercicio favorito
type ExerciseLastWorkout = {
  name: string;
  date: string;
  formattedDate: string;
  sets: { weight: number; reps: number }[];
  maxWeight: number;
  totalVolume: number;
};

const exerciseLastWorkouts = new Map<string, ExerciseLastWorkout>();

if (favoritesData && workoutsData) {
  favoritesData.forEach(fav => {
    const favKey = getFavoriteKey(fav);

    // Buscar el último workout que contenga este ejercicio (workouts ya ordenados desc)
    for (const workout of workoutsData) {
      const matchingSets = workout.exercise_history?.filter(h => matchesFavorite(h, fav)) || [];

      if (matchingSets.length > 0) {
        const sets = matchingSets.map(s => ({ weight: s.weight, reps: s.reps }));
        const maxWeight = Math.max(...sets.map(s => s.weight));
        const totalVolume = sets.reduce((acc, s) => acc + (s.weight * s.reps), 0);

        exerciseLastWorkouts.set(favKey, {
          name: favKey,
          date: workout.workout_date,
          formattedDate: formatShortDate(workout.workout_date),
          sets,
          maxWeight,
          totalVolume
        });
        break; // Solo necesitamos el último
      }
    }
  });
}

// Convertir a objeto para pasar al script del cliente
const exerciseLastWorkoutsData = Object.fromEntries(exerciseLastWorkouts);
---

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - GymApp</title>
  <style>
    .app-header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: var(--space-3) var(--space-4);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    @media (min-width: 768px) {
      .app-header {
        padding: var(--space-4) var(--space-6);
      }
    }

    .logo {
      font-family: var(--font-display);
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 2px;
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    @media (min-width: 768px) {
      .logo {
        font-size: 1.25rem;
        letter-spacing: 3px;
      }
    }

    .logo-dot {
      width: 6px;
      height: 6px;
      background: var(--accent-green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    @media (min-width: 768px) {
      .header-actions {
        gap: var(--space-4);
      }
    }

    .user-name {
      color: var(--text-secondary);
      font-size: 0.75rem;
      display: none;
    }

    @media (min-width: 768px) {
      .user-name {
        display: inline;
        font-size: 0.875rem;
      }
    }

    .header-btn {
      padding: var(--space-1) var(--space-2);
      border-radius: 6px;
      font-size: 0.65rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      text-decoration: none;
      transition: all var(--transition-fast);
      border: 1px solid var(--border-light);
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      white-space: nowrap;
    }

    @media (min-width: 768px) {
      .header-btn {
        padding: var(--space-2) var(--space-4);
        font-size: 0.75rem;
        letter-spacing: 1px;
      }
    }

    .header-btn:hover {
      border-color: var(--text-muted);
      color: var(--text-primary);
    }

    .btn-logout {
      background: var(--accent-red-soft);
      border-color: rgba(255, 59, 48, 0.3);
      color: var(--accent-red);
    }

    .btn-logout:hover {
      background: rgba(255, 59, 48, 0.2);
      border-color: var(--accent-red);
    }

    main {
      padding: var(--space-4);
      max-width: 1400px;
      margin: 0 auto;
    }

    @media (min-width: 768px) {
      main {
        padding: var(--space-6);
      }
    }

    .dashboard-header {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
      align-items: stretch;
      margin-bottom: var(--space-4);
    }

    @media (min-width: 768px) {
      .dashboard-header {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-6);
      }
    }

    .welcome-text h1 {
      font-family: var(--font-display);
      font-size: 1.25rem;
      letter-spacing: 1.5px;
      margin-bottom: var(--space-2);
    }

    @media (min-width: 768px) {
      .welcome-text h1 {
        font-size: 1.75rem;
        letter-spacing: 2px;
      }
    }

    .welcome-text p {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    @media (min-width: 768px) {
      .welcome-text p {
        font-size: 0.875rem;
      }
    }

    .quick-action {
      padding: var(--space-3) var(--space-4);
      background: var(--text-primary);
      color: var(--text-dark);
      border: none;
      border-radius: 8px;
      font-family: var(--font-display);
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all var(--transition-normal);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      text-decoration: none;
      width: 100%;
    }

    @media (min-width: 768px) {
      .quick-action {
        padding: var(--space-3) var(--space-5);
        font-size: 0.75rem;
        width: auto;
      }
    }

    .quick-action:hover {
      opacity: 0.9;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-3);
      margin-bottom: var(--space-4);
    }

    @media (min-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-4);
        margin-bottom: var(--space-6);
      }
    }

    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-4);
      margin-bottom: var(--space-4);
    }

    @media (min-width: 1024px) {
      .dashboard-grid {
        grid-template-columns: 2fr 1fr;
        gap: var(--space-6);
        margin-bottom: var(--space-6);
      }
    }

    /* Section */
    .section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: var(--space-3);
    }

    @media (min-width: 768px) {
      .section {
        border-radius: 12px;
        padding: var(--space-5);
      }
    }

    .section-title {
      font-family: var(--font-display);
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: var(--space-3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    @media (min-width: 768px) {
      .section-title {
        font-size: 0.7rem;
        letter-spacing: 2px;
        margin-bottom: var(--space-5);
      }
    }

    .section-link {
      font-family: var(--font-body);
      font-size: 0.7rem;
      color: var(--text-muted);
      text-decoration: none;
      letter-spacing: 1px;
    }

    .section-link:hover {
      color: var(--text-secondary);
    }

    /* Progress Rings */
    .rings-container {
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: var(--space-4) 0;
    }

    /* Recent Workouts */
    .workout-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .workout-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-2) var(--space-3);
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      transition: all var(--transition-fast);
      gap: var(--space-2);
    }

    @media (min-width: 768px) {
      .workout-item {
        padding: var(--space-3) var(--space-4);
        border-radius: 8px;
      }
    }

    .workout-item:hover {
      border-color: var(--border-light);
      background: var(--bg-tertiary);
    }

    .workout-date {
      font-family: var(--font-display);
      font-size: 0.7rem;
      color: var(--text-primary);
      min-width: 50px;
    }

    @media (min-width: 768px) {
      .workout-date {
        font-size: 0.875rem;
        min-width: 60px;
      }
    }

    .workout-info {
      display: flex;
      gap: var(--space-2);
      flex: 1;
      justify-content: center;
    }

    @media (min-width: 768px) {
      .workout-info {
        gap: var(--space-4);
      }
    }

    .workout-stat {
      font-size: 0.65rem;
      color: var(--text-muted);
    }

    @media (min-width: 768px) {
      .workout-stat {
        font-size: 0.75rem;
      }
    }

    .workout-stat span {
      color: var(--text-secondary);
      font-weight: 500;
    }

    .workout-volume {
      font-family: var(--font-display);
      font-size: 0.75rem;
      color: var(--accent-green);
      min-width: 50px;
      text-align: right;
    }

    @media (min-width: 768px) {
      .workout-volume {
        font-size: 0.875rem;
        min-width: 70px;
      }
    }

    /* PRs */
    .pr-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .pr-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-2) var(--space-3);
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      gap: var(--space-2);
    }

    @media (min-width: 768px) {
      .pr-item {
        padding: var(--space-3) var(--space-4);
        border-radius: 8px;
      }
    }

    .pr-exercise {
      font-size: 0.75rem;
      color: var(--text-primary);
      word-break: break-word;
    }

    @media (min-width: 768px) {
      .pr-exercise {
        font-size: 0.875rem;
      }
    }

    .pr-weight {
      font-family: var(--font-display);
      font-size: 0.875rem;
      color: var(--accent-orange);
      white-space: nowrap;
    }

    @media (min-width: 768px) {
      .pr-weight {
        font-size: 1rem;
      }
    }

    .pr-date {
      font-size: 0.65rem;
      color: var(--text-muted);
    }

    @media (min-width: 768px) {
      .pr-date {
        font-size: 0.7rem;
      }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: var(--space-6);
    }

    @media (min-width: 768px) {
      .empty-state {
        padding: var(--space-8);
      }
    }

    .empty-icon {
      font-size: 2rem;
      margin-bottom: var(--space-3);
      opacity: 0.3;
    }

    @media (min-width: 768px) {
      .empty-icon {
        font-size: 3rem;
        margin-bottom: var(--space-4);
      }
    }

    .empty-title {
      font-family: var(--font-display);
      font-size: 1rem;
      margin-bottom: var(--space-2);
    }

    @media (min-width: 768px) {
      .empty-title {
        font-size: 1.25rem;
      }
    }

    .empty-text {
      color: var(--text-muted);
      font-size: 0.8rem;
      margin-bottom: var(--space-4);
    }

    @media (min-width: 768px) {
      .empty-text {
        font-size: 0.875rem;
        margin-bottom: var(--space-6);
      }
    }

    /* Full Width Section */
    .full-width-section {
      margin-bottom: var(--space-4);
    }

    @media (min-width: 768px) {
      .full-width-section {
        margin-bottom: var(--space-6);
      }
    }

    /* Bottom Grid */
    .bottom-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-4);
    }

    @media (min-width: 768px) {
      .bottom-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 1024px) {
      .bottom-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-6);
      }
    }

    /* Empty Chart */
    .empty-chart {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    /* Period Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: var(--space-4);
      backdrop-filter: blur(8px);
    }

    .modal-overlay.active {
      display: flex;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      padding: var(--space-6);
      max-width: 540px;
      width: 100%;
      position: relative;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-5);
      padding-bottom: var(--space-4);
      border-bottom: 1px solid var(--border);
    }

    .modal-title {
      font-family: var(--font-display);
      font-size: 0.8rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-primary);
    }

    .btn-close-modal {
      padding: 0;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 1.5rem;
      line-height: 1;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast);
    }

    .btn-close-modal:hover {
      color: var(--accent-red);
    }

    .period-tabs {
      display: flex;
      gap: var(--space-2);
      margin-bottom: var(--space-5);
      background: var(--bg-card);
      padding: var(--space-2);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .period-tab {
      flex: 1;
      padding: var(--space-3);
      background: transparent;
      border: none;
      border-radius: 6px;
      font-family: var(--font-body);
      font-size: 0.75rem;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .period-tab:hover {
      color: var(--text-primary);
    }

    .period-tab.active {
      background: var(--text-primary);
      color: var(--bg-primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .quick-periods {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-3);
    }

    .quick-period-btn {
      padding: var(--space-4);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all var(--transition-fast);
      text-align: left;
    }

    .quick-period-btn:hover {
      border-color: var(--border-light);
      background: var(--bg-tertiary);
    }

    .quick-period-btn.selected {
      border-color: var(--accent-green);
      background: var(--accent-green-soft);
    }

    .quick-period-label {
      font-family: var(--font-display);
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: var(--space-1);
    }

    .quick-period-value {
      font-family: var(--font-display);
      font-size: 1.25rem;
      color: var(--text-primary);
      letter-spacing: 1px;
    }

    /* Calendar */
    .calendar-container {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: var(--space-4);
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }

    .calendar-container * {
      box-sizing: border-box;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }

    .calendar-month {
      font-family: var(--font-display);
      font-size: 0.75rem;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .calendar-nav {
      display: flex;
      gap: var(--space-2);
    }

    .calendar-nav-btn {
      padding: var(--space-1);
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-muted);
      cursor: pointer;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast);
    }

    .calendar-nav-btn:hover {
      border-color: var(--accent-green);
      color: var(--accent-green);
    }

    .calendar-grid-container {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
      width: 100%;
      box-sizing: border-box;
    }

    .calendar-day-header {
      font-family: var(--font-display);
      font-size: 0.6rem;
      color: var(--text-muted);
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 0;
      letter-spacing: 0.5px;
      font-weight: 400;
      height: 32px;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 0.8rem;
      font-family: var(--font-body);
      transition: all 0.15s ease;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      user-select: none;
      cursor: pointer;
      position: relative;
    }

    /* Hover de semana completa - borde gris */
    .calendar-day.week-hover {
      background: rgba(160, 160, 160, 0.1);
      border-top: 2px solid rgba(160, 160, 160, 0.4);
      border-bottom: 2px solid rgba(160, 160, 160, 0.4);
      border-left: 1px solid var(--border);
      border-right: 1px solid var(--border);
    }

    .calendar-day.week-hover.week-start {
      border-left: 2px solid rgba(160, 160, 160, 0.4);
      border-top-left-radius: 6px;
      border-bottom-left-radius: 6px;
    }

    .calendar-day.week-hover.week-end {
      border-right: 2px solid rgba(160, 160, 160, 0.4);
      border-top-right-radius: 6px;
      border-bottom-right-radius: 6px;
    }

    /* Semana seleccionada - borde verde */
    .calendar-day.selected-week {
      background: rgba(48, 209, 88, 0.15);
      border-top: 2px solid var(--accent-green);
      border-bottom: 2px solid var(--accent-green);
      border-left: 1px solid var(--border);
      border-right: 1px solid var(--border);
      color: var(--accent-green);
      font-weight: 600;
    }

    .calendar-day.selected-week.week-start {
      border-left: 2px solid var(--accent-green);
      border-top-left-radius: 6px;
      border-bottom-left-radius: 6px;
    }

    .calendar-day.selected-week.week-end {
      border-right: 2px solid var(--accent-green);
      border-top-right-radius: 6px;
      border-bottom-right-radius: 6px;
    }

    .calendar-day.empty {
      opacity: 0;
      pointer-events: none;
      cursor: default;
      border: none;
      background: transparent;
    }

    .calendar-day.today::after {
      content: '';
      position: absolute;
      bottom: 4px;
      width: 4px;
      height: 4px;
      background: var(--accent-orange);
      border-radius: 50%;
    }

    .calendar-day.selected-week.today::after {
      background: var(--text-primary);
    }

    .calendar-info {
      margin-top: var(--space-4);
      padding: var(--space-3) var(--space-4);
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-family: var(--font-body);
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: center;
      letter-spacing: 0.5px;
      transition: all 0.2s ease;
    }

    .modal-actions {
      display: flex;
      gap: var(--space-3);
      margin-top: var(--space-5);
      padding-top: var(--space-4);
      border-top: 1px solid var(--border);
    }

    .btn-modal {
      flex: 1;
      padding: var(--space-3) var(--space-4);
      border-radius: 6px;
      font-family: var(--font-display);
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all var(--transition-fast);
      border: 1px solid var(--border);
    }

    .btn-modal-cancel {
      background: transparent;
      color: var(--text-secondary);
    }

    .btn-modal-cancel:hover {
      border-color: var(--text-muted);
      color: var(--text-primary);
    }

    .btn-modal-apply {
      background: var(--accent-green);
      color: var(--bg-primary);
      border-color: var(--accent-green);
    }

    .btn-modal-apply:hover {
      opacity: 0.9;
    }

    .btn-period-settings {
      padding: var(--space-1) var(--space-2);
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-muted);
      font-size: 0.7rem;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }

    .btn-period-settings:hover {
      border-color: var(--accent-green);
      color: var(--accent-green);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-3);
    }

    .chart-title-with-btn {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      width: 100%;
    }

    .chart-title-text {
      font-family: var(--font-display);
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 2px;
      flex: 1;
    }

    /* Exercise Modal Styles */
    .exercise-modal-content {
      max-width: 400px;
    }

    .exercise-modal-body {
      padding: var(--space-2) 0;
    }

    .exercise-modal-date {
      font-family: var(--font-body);
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: var(--space-4);
      text-align: center;
    }

    .exercise-stats-row {
      display: flex;
      justify-content: space-around;
      gap: var(--space-3);
      padding: var(--space-4);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: var(--space-4);
    }

    .exercise-stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-1);
    }

    .exercise-stat-value {
      font-family: var(--font-display);
      font-size: 1.25rem;
      color: var(--text-primary);
      letter-spacing: 1px;
    }

    .exercise-stat-label {
      font-family: var(--font-body);
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .exercise-sets-title {
      font-family: var(--font-display);
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: var(--space-3);
    }

    .exercise-sets-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      max-height: 200px;
      overflow-y: auto;
    }

    .exercise-set-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-2) var(--space-3);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
    }

    .set-number {
      font-family: var(--font-display);
      font-size: 0.7rem;
      color: var(--text-muted);
      min-width: 20px;
    }

    .set-details {
      font-family: var(--font-display);
      font-size: 0.9rem;
      color: var(--text-primary);
      letter-spacing: 0.5px;
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="logo">
      GYMAPP
      <span class="logo-dot"></span>
    </div>
    <div class="header-actions">
      <span class="user-name">{user?.name}</span>
      <a href="/favorites" class="header-btn">Favoritos</a>
      <a href="/history" class="header-btn">Historial</a>
      {user?.role === 'admin' && (
        <a href="/admin/users" class="header-btn">Usuarios</a>
      )}
      <button class="header-btn btn-logout" id="logoutBtn">Salir</button>
    </div>
  </header>

  <main>
    {hasData ? (
      <>
        <div class="dashboard-header">
          <div class="welcome-text">
            <h1>DASHBOARD</h1>
            <p>Resumen de tu progreso</p>
          </div>
          <a href="/workout/new" class="quick-action">
            + Nuevo Entrenamiento
          </a>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
          <StatCard
            value={stats.totalWorkouts}
            label="Entrenamientos"
            icon="fire"
          />
          <StatCard
            value={(stats.totalVolume / 1000).toFixed(1)}
            unit="t"
            label="Volumen Total"
            change={12}
            icon="weight"
          />
          <StatCard
            value={stats.currentStreak}
            label="Racha Actual"
            unit="dias"
            icon="up"
          />
          <StatCard
            value={stats.thisWeek}
            label="Esta Semana"
            unit="/5"
            icon="time"
          />
        </div>

        <!-- Main Charts -->
        <div class="dashboard-grid">
          {progressSeries.length > 0 ? (
            <div class="section">
              <div class="chart-header">
                <div class="chart-title-with-btn">
                  <span class="chart-title-text">
                    Progreso - Favoritos
                    {periodType === 'last'
                      ? ` (Últimas ${periodValue} ${periodValue === 1 ? 'semana' : 'semanas'})`
                      : periodType === 'range' && dateFrom && dateTo
                        ? ` (${formatShortDate(dateFrom)} - ${formatShortDate(dateTo)})`
                        : ' (Últimas 4 semanas)'}
                  </span>
                  <button class="btn-period-settings" id="btnOpenPeriodModal">
                    <span>⚙</span>
                  </button>
                </div>
              </div>
              <LineChart
                series={progressSeries}
                unit="kg"
                showArea={true}
                width={420}
                height={240}
              />
            </div>
          ) : (
            <div class="section">
              <div class="section-title">Progreso</div>
              <div class="empty-chart">
                <p>Marca ejercicios como favoritos para ver tu progreso</p>
              </div>
            </div>
          )}

          <div class="section">
            <div class="section-title">Objetivos Semanales</div>
            <div class="rings-container">
              <ProgressRing
                value={stats.thisWeek}
                max={5}
                size={100}
                label="Sesiones"
                sublabel={`${stats.thisWeek} de 5`}
                color="green"
              />
              <ProgressRing
                value={stats.totalWorkouts > 0 ? Math.min(100, Math.round((stats.thisWeek / 5) * 100)) : 0}
                max={100}
                size={100}
                label="Meta"
                sublabel={`${stats.totalWorkouts > 0 ? Math.min(100, Math.round((stats.thisWeek / 5) * 100)) : 0}%`}
                color="orange"
              />
            </div>
          </div>
        </div>

        <!-- Volume Chart + Recent -->
        <div class="dashboard-grid">
          {volumeByMuscle.length > 0 ? (
            <BarChart
              title="Volumen por Grupo (mes)"
              data={volumeByMuscle}
              unit="kg"
              showValues={true}
              width={420}
              height={210}
            />
          ) : (
            <div class="section">
              <div class="section-title">Volumen por Grupo Muscular</div>
              <div class="empty-chart">
                <p>Sin datos este mes</p>
              </div>
            </div>
          )}

          <div class="section">
            <div class="section-title">
              Ultimos Entrenamientos
              <a href="/history" class="section-link">Ver todos</a>
            </div>
            {recentWorkouts.length > 0 ? (
              <div class="workout-list">
                {recentWorkouts.map((w) => (
                  <div class="workout-item">
                    <div class="workout-date">{w.date}</div>
                    <div class="workout-info">
                      <span class="workout-stat"><span>{w.exercises}</span> ejerc.</span>
                    </div>
                    <div class="workout-volume">{(w.volume / 1000).toFixed(1)}t</div>
                  </div>
                ))}
              </div>
            ) : (
              <div class="empty-chart">
                <p>Sin entrenamientos recientes</p>
              </div>
            )}
          </div>
        </div>

        <!-- Detailed Muscle Volume Chart -->
        {volumeByMuscleAll.length > 0 && (
          <div class="full-width-section">
            <BarChart
              title="Volumen por Músculo - Detalle (mes)"
              data={volumeByMuscleAll}
              unit="kg"
              showValues={true}
              width={900}
              height={280}
            />
          </div>
        )}

        <!-- PRs Section -->
        {personalRecords.length > 0 && (
          <div class="bottom-grid">
            <div class="section">
              <div class="section-title">Records Personales</div>
              <div class="pr-list">
                {personalRecords.map((pr) => (
                  <div class="pr-item">
                    <div>
                      <div class="pr-exercise">{pr.exercise}</div>
                      <div class="pr-date">{pr.date}</div>
                    </div>
                    <div class="pr-weight">{pr.weight}kg</div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}
      </>
    ) : (
      <div class="empty-state">
        <div class="empty-icon">◇</div>
        <h2 class="empty-title">BIENVENIDO</h2>
        <p class="empty-text">
          Aun no tienes entrenamientos registrados.<br>
          Comienza a trackear tu progreso.
        </p>
        <a href="/workout/new" class="quick-action">
          + Primer Entrenamiento
        </a>
      </div>
    )}
  </main>

  <!-- Modal de Períodos -->
  <div class="modal-overlay" id="periodModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Período de Análisis</h2>
        <button class="btn-close-modal" id="btnCloseModal">×</button>
      </div>

      <div class="period-tabs">
        <button class="period-tab active" data-tab="quick">Rápido</button>
        <button class="period-tab" data-tab="custom">Personalizado</button>
      </div>

      <!-- Tab Rápido -->
      <div class="tab-content active" id="quickTab">
        <div class="quick-periods">
          <button class="quick-period-btn selected" data-value="4">
            <div class="quick-period-label">Últimas</div>
            <div class="quick-period-value">4 sem</div>
          </button>
          <button class="quick-period-btn" data-value="8">
            <div class="quick-period-label">Últimas</div>
            <div class="quick-period-value">8 sem</div>
          </button>
          <button class="quick-period-btn" data-value="12">
            <div class="quick-period-label">Últimas</div>
            <div class="quick-period-value">12 sem</div>
          </button>
          <button class="quick-period-btn" data-value="16">
            <div class="quick-period-label">Últimas</div>
            <div class="quick-period-value">16 sem</div>
          </button>
        </div>
      </div>

      <!-- Tab Personalizado -->
      <div class="tab-content" id="customTab">
        <div class="calendar-container">
          <div class="calendar-header">
            <button class="calendar-nav-btn" id="prevMonth">‹</button>
            <div class="calendar-month" id="currentMonth"></div>
            <button class="calendar-nav-btn" id="nextMonth">›</button>
          </div>
          <div class="calendar-grid-container" id="calendarContainer"></div>
          <div class="calendar-info" id="calendarInfo">
            Selecciona una semana completa (de lunes a domingo)
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-modal btn-modal-cancel" id="btnCancelModal">Cancelar</button>
        <button type="button" class="btn-modal btn-modal-apply" id="btnApplyModal">Aplicar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Detalle de Ejercicio -->
  <div class="modal-overlay" id="exerciseModal">
    <div class="modal-content exercise-modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="exerciseModalTitle">Ejercicio</h2>
        <button class="btn-close-modal" id="btnCloseExerciseModal">×</button>
      </div>

      <div class="exercise-modal-body">
        <div class="exercise-modal-date" id="exerciseModalDate"></div>

        <div class="exercise-stats-row">
          <div class="exercise-stat-item">
            <span class="exercise-stat-value" id="exerciseMaxWeight">-</span>
            <span class="exercise-stat-label">Peso Máx</span>
          </div>
          <div class="exercise-stat-item">
            <span class="exercise-stat-value" id="exerciseTotalVolume">-</span>
            <span class="exercise-stat-label">Volumen</span>
          </div>
          <div class="exercise-stat-item">
            <span class="exercise-stat-value" id="exerciseTotalSets">-</span>
            <span class="exercise-stat-label">Series</span>
          </div>
        </div>

        <div class="exercise-sets-title">Series</div>
        <div class="exercise-sets-list" id="exerciseSetsList"></div>
      </div>
    </div>
  </div>

  <script define:vars={{ periodType, periodValue, dateFrom, dateTo, exerciseLastWorkoutsData }}>
    // Elementos del DOM
    const modal = document.getElementById('periodModal');
    const btnOpen = document.getElementById('btnOpenPeriodModal');
    const btnClose = document.getElementById('btnCloseModal');
    const btnCancel = document.getElementById('btnCancelModal');
    const btnApply = document.getElementById('btnApplyModal');
    const periodTabs = document.querySelectorAll('.period-tab');
    const quickTab = document.getElementById('quickTab');
    const customTab = document.getElementById('customTab');
    const quickPeriodBtns = document.querySelectorAll('.quick-period-btn');
    const calendarContainer = document.getElementById('calendarContainer');
    const currentMonthEl = document.getElementById('currentMonth');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const calendarInfo = document.getElementById('calendarInfo');

    // Estado
    let activeTab = 'quick';
    let selectedPeriodType = periodType || 'last';
    let selectedPeriodValue = periodValue || 4; // 4 semanas por defecto
    let selectedDateFrom = dateFrom;
    let selectedDateTo = dateTo;
    let currentDate = new Date();
    let rangeStart = null;
    let rangeEnd = null;

    // Inicializar valores según URL
    if (periodType === 'range' && dateFrom && dateTo) {
      activeTab = 'custom';
      rangeStart = new Date(dateFrom);
      rangeEnd = new Date(dateTo);
    } else {
      quickPeriodBtns.forEach(btn => {
        if (parseInt(btn.dataset.value) === selectedPeriodValue) {
          btn.classList.add('selected');
        } else {
          btn.classList.remove('selected');
        }
      });
    }

    // Abrir/cerrar modal
    btnOpen?.addEventListener('click', () => {
      modal.classList.add('active');
      if (activeTab === 'custom') {
        renderCalendar();
      }
    });

    const closeModal = () => {
      modal.classList.remove('active');
    };

    btnClose.addEventListener('click', closeModal);
    btnCancel.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    // Cambiar tabs
    periodTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        activeTab = tabName;

        periodTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        if (tabName === 'quick') {
          quickTab.classList.add('active');
          customTab.classList.remove('active');
        } else {
          quickTab.classList.remove('active');
          customTab.classList.add('active');
          renderCalendar();
        }
      });
    });

    // Inicializar tab activo
    if (activeTab === 'custom') {
      periodTabs.forEach(t => {
        if (t.dataset.tab === 'custom') {
          t.classList.add('active');
        } else {
          t.classList.remove('active');
        }
      });
      quickTab.classList.remove('active');
      customTab.classList.add('active');
    }

    // Selección rápida
    quickPeriodBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        quickPeriodBtns.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedPeriodValue = parseInt(btn.dataset.value);
      });
    });

    // Helpers de calendario
    function getMonday(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }

    function getSunday(monday) {
      const d = new Date(monday);
      d.setDate(d.getDate() + 6);
      return d;
    }

    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    function isSameDay(d1, d2) {
      return d1.getDate() === d2.getDate() &&
             d1.getMonth() === d2.getMonth() &&
             d1.getFullYear() === d2.getFullYear();
    }

    function isInRange(date, start, end) {
      return date >= start && date <= end;
    }

    // Renderizar calendario
    function renderCalendar() {
      if (!calendarContainer) return;

      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      // Header
      const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      currentMonthEl.textContent = `${monthNames[month]} ${year}`;

      calendarContainer.innerHTML = '';

      // Agregar headers de días de la semana
      const dayHeaders = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
      dayHeaders.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day-header';
        header.textContent = day;
        calendarContainer.appendChild(header);
      });

      // Obtener primer día del mes
      const firstDay = new Date(year, month, 1);
      const startDate = new Date(getMonday(firstDay));
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Generar 42 días (6 semanas x 7 días)
      for (let i = 0; i < 42; i++) {
        const currentDay = new Date(startDate);
        currentDay.setDate(startDate.getDate() + i);

        const weekStart = getMonday(currentDay);
        const weekEnd = getSunday(weekStart);

        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        dayEl.dataset.weekStart = formatDate(weekStart);

        // Si el día pertenece al mes actual
        if (currentDay.getMonth() === month) {
          dayEl.textContent = currentDay.getDate();
          dayEl.dataset.date = formatDate(currentDay);

          // Marcar inicio y fin de semana
          if (isSameDay(currentDay, weekStart)) {
            dayEl.classList.add('week-start');
          }
          if (isSameDay(currentDay, weekEnd)) {
            dayEl.classList.add('week-end');
          }

          // Marcar hoy
          if (isSameDay(currentDay, today)) {
            dayEl.classList.add('today');
          }

          // Marcar si está en la semana seleccionada
          if (rangeStart && rangeEnd && isSameDay(weekStart, rangeStart) && isSameDay(weekEnd, rangeEnd)) {
            dayEl.classList.add('selected-week');
          }

          // Click para seleccionar semana
          dayEl.addEventListener('click', () => selectWeek(weekStart));

          // Hover para resaltar semana
          dayEl.addEventListener('mouseenter', () => {
            highlightWeek(weekStart, true);
          });
          dayEl.addEventListener('mouseleave', () => {
            highlightWeek(weekStart, false);
          });
        } else {
          // Día de otro mes
          dayEl.classList.add('empty');
        }

        calendarContainer.appendChild(dayEl);
      }
    }

    // Resaltar semana en hover
    function highlightWeek(weekStart, highlight) {
      const weekStartStr = formatDate(weekStart);
      document.querySelectorAll('.calendar-day').forEach(day => {
        if (day.dataset.weekStart === weekStartStr && !day.classList.contains('selected-week')) {
          if (highlight) {
            day.classList.add('week-hover');
          } else {
            day.classList.remove('week-hover');
          }
        }
      });
    }

    // Seleccionar semana
    function selectWeek(weekStart) {
      rangeStart = new Date(weekStart);
      rangeEnd = getSunday(rangeStart);
      renderCalendar();

      const startStr = rangeStart.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
      const endStr = rangeEnd.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
      calendarInfo.textContent = `✓ Semana seleccionada: ${startStr} - ${endStr}`;
      calendarInfo.style.color = 'var(--accent-green)';
      calendarInfo.style.fontWeight = '500';
    }

    // Navegación del calendario
    prevMonthBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    });

    nextMonthBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    });

    // Aplicar cambios
    btnApply.addEventListener('click', () => {
      const url = new URL(window.location.href);

      if (activeTab === 'quick') {
        url.searchParams.set('periodType', 'last');
        url.searchParams.set('periodValue', selectedPeriodValue.toString());
        url.searchParams.delete('dateFrom');
        url.searchParams.delete('dateTo');
      } else {
        if (!rangeStart || !rangeEnd) {
          alert('Por favor selecciona una semana en el calendario');
          return;
        }
        url.searchParams.set('periodType', 'range');
        url.searchParams.set('dateFrom', formatDate(rangeStart));
        url.searchParams.set('dateTo', formatDate(rangeEnd));
        url.searchParams.delete('periodValue');
      }

      window.location.href = url.toString();
    });

    // === Modal de Ejercicio ===
    const exerciseModal = document.getElementById('exerciseModal');
    const btnCloseExercise = document.getElementById('btnCloseExerciseModal');
    const exerciseModalTitle = document.getElementById('exerciseModalTitle');
    const exerciseModalDate = document.getElementById('exerciseModalDate');
    const exerciseMaxWeight = document.getElementById('exerciseMaxWeight');
    const exerciseTotalVolume = document.getElementById('exerciseTotalVolume');
    const exerciseTotalSets = document.getElementById('exerciseTotalSets');
    const exerciseSetsList = document.getElementById('exerciseSetsList');

    // Cerrar modal de ejercicio
    const closeExerciseModal = () => {
      exerciseModal?.classList.remove('active');
    };

    btnCloseExercise?.addEventListener('click', closeExerciseModal);
    exerciseModal?.addEventListener('click', (e) => {
      if (e.target === exerciseModal) closeExerciseModal();
    });

    // Abrir modal al hacer clic en un ejercicio de la leyenda
    document.querySelectorAll('.legend-item-html[data-exercise-name]').forEach(item => {
      item.addEventListener('click', () => {
        const exerciseName = item.getAttribute('data-exercise-name');
        if (!exerciseName) return;

        const exerciseData = exerciseLastWorkoutsData[exerciseName];
        if (!exerciseData) {
          alert('No hay datos disponibles para este ejercicio');
          return;
        }

        // Poblar modal
        exerciseModalTitle.textContent = exerciseData.name.length > 30
          ? exerciseData.name.substring(0, 30) + '...'
          : exerciseData.name;
        exerciseModalDate.textContent = `Último: ${exerciseData.formattedDate}`;
        exerciseMaxWeight.textContent = `${exerciseData.maxWeight}kg`;
        exerciseTotalVolume.textContent = `${(exerciseData.totalVolume / 1000).toFixed(1)}t`;
        exerciseTotalSets.textContent = exerciseData.sets.length;

        // Renderizar sets
        exerciseSetsList.innerHTML = exerciseData.sets.map((set, i) => `
          <div class="exercise-set-item">
            <span class="set-number">${i + 1}</span>
            <span class="set-details">${set.weight}kg × ${set.reps}</span>
          </div>
        `).join('');

        exerciseModal?.classList.add('active');
      });

      // También permitir abrir con Enter
      item.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') item.click();
      });
    });

    // Logout
    document.getElementById('logoutBtn')?.addEventListener('click', async () => {
      await fetch('/api/auth/logout', { method: 'POST' })
      window.location.href = '/login'
    })
  </script>
</body>
</html>
